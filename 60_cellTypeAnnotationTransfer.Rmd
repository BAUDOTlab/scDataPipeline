---
output:
    html_document
---

```{r mapping-atlas{{STEP_ID}}}
# rdsObject generated by the code ...
# the file is considered as an inputs of the atlas


atlas.subset <- readRDS(file.path(PATH_ATLAS, "atlas_preprocessed.rds"))
colname <- ifelse(args[1] != "dea", "celltype_DF", "celltype_singleData")
prediction_file <- file.path(PATH_OUT_ANALYSIS, paste0("transferAnnotation_", ifelse(args[1] != "dea", "DF_", "singleData_"), DATASET, ".csv"))

if(!file.exists(prediction_file)){
    anchors <- FindTransferAnchors(reference = atlas.subset, query = fltd,
                                dims = 1:top_pcs, reference.reduction = "pca",
                                k.anchor = 5, k.filter = 200)
    predictions <- TransferData(anchorset = anchors, refdata = atlas.subset$celltype,
                                dims = 1:top_pcs)

    predictions <- cbind(cellIDs = rownames(predictions), predictions)
    write.table(
        predictions,
        file = prediction_file,
        sep = ",",
        row.names = FALSE,
        col.names = TRUE
    )
} else {
    predictions <- read.table(prediction_file, sep=",", header=T)
}

fltd <- AddMetaData(fltd, metadata = predictions[,"predicted.id"], col.name = colname)

# Exports predictions
filename <- paste0("transferAnnotation_", ifelse(args[1] != "dea", "DF_", "singleData_"), DATASET, ".csv")

rm(predictions)
invisible(gc())

if (args[1] != "dea"){
    Idents(fltd) <- "celltype_DF"
    plotTitle <- paste0(DATASET, if (exists("msg")) {paste0(" - ", msg)} , "\ncell type repartition to perform DoubletFinder")
} else {
    Idents(fltd) <- "celltype_singleData"
    plotTitle <- paste0(DATASET, "\ncell type repartition")
}

# PLOT
ggplot(fltd@meta.data, aes(x = celltype_DF, fill = celltype_DF)) +
    geom_point(stat = "count", aes(y = after_stat(count + (count*10)/100)), color = "transparent") +
    geom_bar(stat = "count") +
    scale_fill_manual(values = colors.celltype[levels(Idents(fltd))]) +
    labs(x = NULL, y = "Number of cells") +
    coord_flip() +
    NoLegend() +
    geom_text(
        aes(label = after_stat(count)), hjust = -0.3,
        stat = "count"
    ) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.y = element_text(size = 12))
```
