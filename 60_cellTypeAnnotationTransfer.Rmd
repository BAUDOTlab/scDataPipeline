---
output:
    html_document
---

```{r mapping-atlas{{STEP_ID}}}
# rdsObject generated by the code ...
# the file is considered as an inputs of the atlas
atlas.subset <- readRDS(file.path(PATH_ATLAS, "Li-et-al_atlas_preprocessed_ENSid.rds"))
colname <- ifelse(args[1] != "dea", "tissue_DF", "tissue_singleData")

anchors <- FindTransferAnchors(reference = atlas.subset, query = fltd,
                               dims = 1:top_pcs, reference.reduction = "pca",
                               k.anchor = 5, k.filter = 200)
predictions <- TransferData(anchorset = anchors, refdata = atlas.subset$celltype,
                            dims = 1:top_pcs)
fltd <- AddMetaData(fltd, metadata = predictions[,"predicted.id"], col.name = colname)

# Exports predictions
filename <- paste0("transferAnnotation_", ifelse(args[1] != "dea", "DF_", "singleData_"), DATASET, ".csv")
predictions <- cbind(cellIDs = rownames(predictions), predictions)
write.table(
    predictions,
    file = file.path(
        PATH_OUT_ANALYSIS,
        filename),
    sep = ",",
    row.names = FALSE,
    col.names = TRUE
)


rm(predictions)
invisible(gc())

if (args[1] != "dea"){
    Idents(fltd) <- "tissue_DF"
    plotTitle <- paste0(DATASET, if (exists("msg")) {paste0(" - ", msg)} , "\ncell type repartition to perform DoubletFinder")
} else {
    Idents(fltd) <- "tissue_singleData"
    plotTitle <- paste0(DATASET, "\ncell type repartition")
}

# PLOT
ggplot(fltd@meta.data, aes(x = tissue_DF, fill = tissue_DF)) +
    geom_point(stat = "count", aes(y = after_stat(count + (count*10)/100)), color = "transparent") +
    geom_bar(stat = "count") +
    scale_fill_manual(values = colors.celltype[levels(Idents(fltd))]) +
    labs(x = NULL, y = "Number of cells") +
    coord_flip() +
    NoLegend() +
    geom_text(
        aes(label = after_stat(count)), hjust = -0.3,
        stat = "count"
    ) +
  ggtitle(plotTitle) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.y = element_text(size = 12))
```